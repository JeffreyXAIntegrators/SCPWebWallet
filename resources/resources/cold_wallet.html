<!DOCTYPE html>
<html>
  <head>
    <title>ScPrime Web Wallet</title>
    <meta http-equiv="PRAGMA" content="NO-CACHE">
    <meta http-equiv="CACHE-CONTROL" content="NO-CACHE">
  </head>
  <body id="coldWallet">
    <h1 class="center">ScPrime</h1>
    <h2 class="center">Cold Wallet</h2>
    <div id="content" class="pad center">
        Loading...
    </div>
    <style>
&STYLE;
    </style>
    <script>
      var addresses = []
      var address
      var seed
      function displayStartupMenu() {
        addresses = []
        address = ""
        seed = ""
        document.getElementById('content').innerHTML = `<div class='pad dashed'></div>`
        document.getElementById('content').innerHTML += `<div class='pad'><button onclick='displayUnlockWallet()'>Unlock Existing</button></div>`
        document.getElementById('content').innerHTML += `<div class='pad'><button onclick='displayRestoreFromSeed()'>Restore From Seed</button></div>`
        document.getElementById('content').innerHTML += `<div class='pad'><button onclick='displayNewWallet()'>Create New Wallet</button></div>`
      }
      function displayNewWallet() {
        displayWallet(newWalletSeed())
      }
      function displayRestoreFromSeed() {
        document.getElementById('content').innerHTML = `<div class='pad'><button onclick='displayStartupMenu()'>Close</button></div>`
        document.getElementById('content').innerHTML += `<div class='pad dashed'></div>`
        document.getElementById('content').innerHTML += `<div class='pad'>Seed:</div>`
        document.getElementById('content').innerHTML += `<div class='pad'><input type="password" id="restoreThisSeed"></div>`
        document.getElementById('content').innerHTML += `<div class='pad'><button onclick='displayWallet(document.getElementById("restoreThisSeed").value)'>Restore</button></div>`
      }
      function displayWallet(aSeed) {
        seed = aSeed
        if (addresses.length == 0) {
          for (var i = 0; i < 1000; i++) {
            addresses.push(addressFromSeed(seed, i).toLowerCase())
          }
        }
        address = addresses[0]
        document.getElementById('content').innerHTML = `<div class='pad'><button onclick='displaySaveThisWallet()'>Save</button> <button onclick='displayStartupMenu()'>Close</button></div>`
        document.getElementById('content').innerHTML += `<div class='pad dashed'></div>`
        document.getElementById('content').innerHTML += `<div class='pad'>Wallet Summary:</div>`
        document.getElementById('content').innerHTML += `<div id='confirmedScpBalance' class='pad'>Loading...</div>`
        document.getElementById('content').innerHTML += `<div id='confirmedSpfBalance' class='pad'>Loading...</div>`
        document.getElementById('content').innerHTML += `<div id='numberOfTransactions' class='pad'>Loading...</div>`
        document.getElementById('content').innerHTML += `<div class='pad dashed'></div>`
        document.getElementById('content').innerHTML += `<div class='pad'>Receive Coins At:</div>`
        document.getElementById('content').innerHTML += `<div class='pad'>${address} <font id='copiedAddressIcon'></font></div>`
        document.getElementById('content').innerHTML += `<div class='pad'><button onclick="copyAddressToClipboard()">Copy</button></div>`
        document.getElementById('content').innerHTML += `<div class='pad dashed'></div>`
        document.getElementById('content').innerHTML += `<div class='pad'>Seed:</div>`
        document.getElementById('content').innerHTML += `<div class='pad'>${seed} <font id='copiedSeedIcon'></font></div>`
        document.getElementById('content').innerHTML += `<div class='pad'><button onclick='copySeedToClipboard()'>Copy</button></div>`
        fetch("https://explorer.scpri.me/navigator-api/addresses", {
          "headers": {
            "Accept": "application/json, text/plain, */*",
            "Accept-Language": "en-US,en;q=0.5",
            "Content-Type": "application/json",
            "Sec-Fetch-Dest": "empty",
            "Sec-Fetch-Mode": "cors",
            "Sec-Fetch-Site": "same-origin"
          },
          "body": JSON.stringify({query: addresses.join("\n")}),
          "method": "POST",
          "mode": "cors"
        }).then(response => response.json())
          .then(result => {
            document.getElementById('confirmedScpBalance').innerHTML = `Confirmed SCP Balance: ${result[0].balanceSc/1000000000000000000000000000} SCP`
            document.getElementById('confirmedSpfBalance').innerHTML = `Confirmed SPF Balance: ${result[0].balanceSf} SPF`
            document.getElementById('numberOfTransactions').innerHTML = `Number of Transactions: ${result[0].TotalTxCount}`
          })
          .catch(error => {
            console.error("Error:", error);
          })
      }
      function displaySaveThisWallet() {
        document.getElementById('content').innerHTML = `<div class='pad'><button onclick='displayStartupMenu()'>Close</button></div>`
        document.getElementById('content').innerHTML += `<div class='pad dashed'></div>`
        document.getElementById('content').innerHTML += `<div class='pad'>Wallet Name:</div>`
        document.getElementById('content').innerHTML += `<div class='pad'><input type="text" id="saveThisWalletName"></div>`
        document.getElementById('content').innerHTML += `<div class='pad'>Wallet Password:</div>`
        document.getElementById('content').innerHTML += `<div class='pad'><input type="password" id="saveThisWalletPass"></div>`
	      document.getElementById('content').innerHTML += `<div class='pad'><button onclick='saveThisWallet(document.getElementById("saveThisWalletName").value, document.getElementById("saveThisWalletPass").value, "${seed}")'>Save</button></div>`
      }
      function saveThisWallet(aName, aPass, aSeed) {
        localStorage.setItem(aName + '~~~~' + aPass, aSeed)
        displayWallet(seed)
      }
      function displayUnlockWallet() {
        document.getElementById('content').innerHTML = `<div class='pad'><button onclick='displayStartupMenu()'>Close</button></div>`
        document.getElementById('content').innerHTML += `<div class='pad dashed'></div>`
        document.getElementById('content').innerHTML += `<div class='pad'>Wallet Name:</div>`
        document.getElementById('content').innerHTML += `<div class='pad'><input type="text" id="unlockThisWalletName"></div>`
        document.getElementById('content').innerHTML += `<div class='pad'>Wallet Password:</div>`
        document.getElementById('content').innerHTML += `<div class='pad'><input type="password" id="unlockThisWalletPass"></div>`
        document.getElementById('content').innerHTML += `<div class='pad'><button onclick='unlockThisWallet(document.getElementById("unlockThisWalletName").value, document.getElementById("unlockThisWalletPass").value)'>Unlock</button></div>`
      }
      function unlockThisWallet(aName, aPass) {
        seed = localStorage.getItem(aName + '~~~~' + aPass)
        displayWallet(seed)
      }
      function addCopiedAddressIcon() {
        document.getElementById('copiedAddressIcon').innerHTML = 'üñ®Ô∏è'
      }
      function addCopiedSeedIcon() {
        document.getElementById('copiedSeedIcon').innerHTML = 'üñ®Ô∏è'
      }
      function removeCopiedAddressIcon() {
        document.getElementById('copiedAddressIcon').innerHTML = ''
      }
      function removeCopiedSeedIcon() {
        document.getElementById('copiedSeedIcon').innerHTML = ''
      }
      function copyAddressToClipboard() {
        copyToClipboard(address)
        addCopiedAddressIcon()
        removeCopiedSeedIcon()
      }
      function copySeedToClipboard() {
        copyToClipboard(seed)
        removeCopiedAddressIcon()
        addCopiedSeedIcon()
      }
      // returns a new random wallet seed
      function newWalletSeed() {
        return wasmNewWalletSeed()
      }
      // returns the address from the seed
      function addressFromSeed(seed, offset) {
        return wasmAddressFromSeed(seed, offset)
      }
      // return the utxo pool for the last 100 transactions
      // this is sort of hacked together because there is not 
      // a perfect way to determine if a transaction is already 
      // spent by just looking at the API response from scprime.info,
      // though perhaps in the future scprime.info can add an IsSpent 
      // boolean to every transaction?
      function constructUtxoPoolFromLast100Transactions(last100Transactions) {
        var utxoPool = []
        for (var i = 0; i < last100Transactions.length; i++) {
          transaction = last100Transactions[i]
          // do not spend transactions that contain SPF
          if (transaction.SfChange == 0 && transaction.ScChange > 0) {
            var isSpent = false;
            for (var j = 0; j < last100Transactions.length; j++) {
              if (transaction.ScChange == (last100Transactions[j].ScChange * -1)) {
                isSpent = true
                break;
              }
            }
            if (!isSpent) {
              utxoPool.push(transaction)
            }
          }
        }
        return utxoPool
      }
      // constructs an SCP spend
      function fundSiacoins(targetAddress, amount) {
        fetch("https://explorer.scpri.me/navigator-api/addresses", {
          "headers": {
            "Accept": "application/json, text/plain, */*",
            "Accept-Language": "en-US,en;q=0.5",
            "Content-Type": "application/json",
            "Sec-Fetch-Dest": "empty",
            "Sec-Fetch-Mode": "cors",
            "Sec-Fetch-Site": "same-origin"
          },
          "body": JSON.stringify({query: addresses.join("\n")}),
          "method": "POST",
          "mode": "cors"
        }).then(response => response.json())
          .then(result => {
            var utxoPool = constructUtxoPoolFromLast100Transactions(result[2].last100Transactions)
            var spendTransaction = {}
            spendTransaction.transaction = {}
            spendTransaction.transaction.siacoininputs = []
            spendTransaction.transaction.siacoinoutputs = []
            var totalAmount = 0
            for (var i = 0; i < utxoPool.length; i++) {
              var utxo = utxoPool[i]
              var siacoinInput = {}
              siacoinInput.parentid = utxo.MasterHash
              siacoinInput.unlockconditions = {}
              siacoinInput.unlockconditions.timelock = 0
              siacoinInput.unlockconditions.publickeys = ["ed25519:" + utxo.Address]
              siacoinInput.unlockconditions.signaturesrequired = 1
              spendTransaction.transaction.siacoininputs.push(siacoinInput)
              totalAmount += utxo.ScChange
            }
            siacoinOutput = {}
            siacoinOutput.value = amount.toLocaleString('fullwide', {useGrouping:false})
            siacoinOutput.unlockhash = targetAddress
            spendTransaction.transaction.siacoinoutputs.push(siacoinOutput)
            var fee = 100000000000000000000000000
            spendTransaction.transaction.minerfees = [ fee.toLocaleString('fullwide', {useGrouping:false}) ]
            changeOutput = {}
            changeOutput.value = (totalAmount - amount - fee).toLocaleString('fullwide', {useGrouping:false})
            changeOutput.unlockhash = address
            spendTransaction.transaction.siacoinoutputs.push(changeOutput)
            console.log(JSON.stringify(spendTransaction))
          })
          .catch(error => {
            console.error("Error:", error);
          })
      }
    </script>
    <script>
&SCRIPT;
    </script>
    <script>
&WASM_EXEC;
    </script>
    <script>
      const go = new Go();
      WebAssembly.instantiateStreaming(fetch("data:application/wasm;base64,&WALLET_WASM;"), go.importObject).then((result) => {
        go.run(result.instance);
	displayStartupMenu()
      })
    </script>
  </body>
</html>

